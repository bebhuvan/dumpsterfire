---
import BaseLayout from './BaseLayout.astro';
import SocialShare from '../components/SocialShare.astro';
import EmbedProcessor from '../components/EmbedProcessor.astro';

export interface Props {
  title: string;
  subtitle?: string;
  source: string;
  originalUrl?: string;
  publishDate: string;
  readingTime: number;
  type: string;
  issueNumber?: number;
  curatorNotes?: string;
  pullQuote?: string;
  tags?: string[];
}

const { 
  title, 
  subtitle, 
  source, 
  originalUrl, 
  publishDate, 
  readingTime, 
  type, 
  issueNumber, 
  curatorNotes, 
  pullQuote,
  tags = []
} = Astro.props;

const typeClassMap: { [key: string]: string } = {
  essay: 'meta-essay',
  podcast: 'meta-podcast',
  newsletter: 'meta-newsletter',
  video: 'meta-video',
  book: 'meta-book',
  paper: 'meta-paper',
  thread: 'meta-thread'
};

const typeClass = typeClassMap[type.toLowerCase()] || 'meta-essay';

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric', 
    year: 'numeric' 
  });
};
---

<BaseLayout title={title} issueNumber={issueNumber}>
  <style is:global>
    .article-container {
      max-width: 680px;
      margin: 0 auto;
      padding: var(--spacing-xl) 2rem;
    }
    
    .breadcrumb {
      font-size: .8rem;
      color: var(--text-tertiary);
      margin-bottom: 2rem;
    }
    
    .breadcrumb a {
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color .2s;
    }
    
    .breadcrumb a:hover {
      color: var(--text-secondary);
    }
    
    .breadcrumb-sep {
      margin: 0 .5rem;
      opacity: 0.4;
    }
    
    .article-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border-light);
    }
    
    .article-meta-top {
      display: flex;
      gap: 1rem;
      align-items: baseline;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .article-type {
      font-size: .7rem;
      color: var(--text-tertiary);
      margin-bottom: 0;
      letter-spacing: .08em;
      display: inline-block;
      padding: 0;
      background: none;
      border: none;
      font-weight: 600;
      text-transform: uppercase;
    }

    .meta-essay {
      color: var(--text-primary);
      background: var(--pastel-blue);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .meta-podcast {
      color: var(--text-primary);
      background: var(--pastel-mint);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .meta-newsletter {
      color: var(--text-primary);
      background: var(--pastel-lavender);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .meta-video {
      color: var(--text-primary);
      background: var(--pastel-coral);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .meta-book {
      color: var(--text-primary);
      background: var(--pastel-sage);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .meta-paper {
      color: var(--text-primary);
      background: var(--pastel-peach);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .meta-thread {
      color: var(--text-primary);
      background: var(--pastel-yellow);
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }
    
    .article-date {
      font-size: .85rem;
      color: var(--text-tertiary);
    }
    
    .article-title {
      font-size: 2.4rem;
      line-height: 1.3;
      margin-bottom: var(--spacing-md);
      font-weight: 400;
      letter-spacing: -0.02em;
    }
    
    .article-subtitle {
      font-size: 1.2rem;
      line-height: 1.5;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 1.5rem;
    }
    
    .article-meta-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    
    .article-source .source-label {
      color: var(--text-tertiary);
    }
    
    .article-source .source-link {
      color: var(--text-secondary);
      text-decoration: none;
      border-bottom: 1px solid var(--border-light);
      transition: border-color .2s;
      font-weight: 500;
      letter-spacing: .01em;
    }
    
    .article-source .source-link:hover {
      border-color: var(--text-secondary);
    }
    
    .article-stats {
      display: flex;
      gap: 1.5rem;
      font-size: .85rem;
      color: var(--text-tertiary);
    }
    
    .curator-section {
      position: relative;
      background: linear-gradient(135deg, rgba(184, 212, 184, 0.08) 0%, rgba(181, 216, 255, 0.05) 100%);
      padding: 2.5rem 3rem;
      border-radius: 8px;
      margin: 3rem 0;
      border: 1px solid rgba(184, 212, 184, 0.2);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.02);
    }

    .curator-section::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(to bottom, var(--pastel-sage), var(--pastel-mint));
      border-radius: 8px 0 0 8px;
    }
    
    .curator-label {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--text-tertiary);
      margin-bottom: 1.2rem;
      font-weight: 600;
      opacity: 0.8;
    }
    
    .curator-notes {
      font-size: 1.05rem;
      line-height: 1.75;
      color: var(--text-primary);
      font-style: normal;
      font-weight: 500;
    }

    .curator-notes p {
      margin: 0;
    }
    
    .highlight-quote {
      position: relative;
      padding: 3rem 3.5rem 2.5rem 4rem;
      margin: 4rem 0;
      background: linear-gradient(135deg, rgba(255, 181, 181, 0.06) 0%, rgba(255, 230, 181, 0.04) 100%);
      border: 1px solid rgba(255, 181, 181, 0.15);
      border-radius: 12px;
      font-size: 1.25rem;
      line-height: 1.8;
      color: var(--text-primary);
      font-style: italic;
      font-weight: 400;
      text-align: center;
    }

    .highlight-quote::before {
      content: "\201C";
      position: absolute;
      top: 1rem;
      left: 1.5rem;
      font-size: 2.5rem;
      color: rgba(255, 181, 181, 0.4);
      font-family: "Times New Roman", Times, serif;
      line-height: 1;
      font-weight: bold;
    }

    .highlight-quote::after {
      content: "\201D";
      position: absolute;
      bottom: 0.5rem;
      right: 1.5rem;
      font-size: 2.5rem;
      color: rgba(255, 181, 181, 0.4);
      font-family: "Times New Roman", Times, serif;
      line-height: 1;
      font-weight: bold;
    }
    
    .article-excerpt {
      font-size: 1.15rem;
      line-height: 1.85;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }
    
    .article-excerpt p {
      margin-bottom: var(--spacing-md);
    }
    
    .article-excerpt p:last-child {
      margin-bottom: 0;
    }
    
    .original-link {
      display: inline-flex;
      align-items: center;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 0.9rem;
      margin: 2.5rem 0;
      padding: 1rem 1.8rem;
      background: var(--pastel-blue);
      border: none;
      border-radius: 4px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    .original-link::after {
      content: "→";
      margin-left: 0.5rem;
    }
    
    .tags-section {
      margin: 3rem 0;
      padding-top: 2rem;
      border-top: 1px solid var(--border-light);
    }
    
    .tags-label {
      font-size: .85rem;
      color: var(--text-tertiary);
      margin-bottom: 1rem;
    }
    
    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
    }
    
    .tag {
      font-size: .8rem;
      padding: .4rem .9rem;
      background: var(--pastel-mint);
      border: none;
      border-radius: 15px;
      text-decoration: none;
      color: var(--text-primary);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      line-height: 1;
    }
    
    
    @media (max-width: 768px) {
      .article-container {
        padding: 2rem 1.5rem;
      }
      
      .article-title {
        font-size: 1.8rem;
      }
      
      .article-meta-bottom {
        flex-direction: column;
        align-items: flex-start;
      }

      .curator-section {
        padding: 2rem;
        margin: 2rem 0;
      }

      .curator-section::before {
        width: 3px;
      }

      .highlight-quote {
        padding: 2rem 2.5rem;
        margin: 2.5rem 0;
        font-size: 1.1rem;
        text-align: left;
      }

      .highlight-quote::before {
        top: 0.5rem;
        left: 1rem;
        font-size: 2rem;
      }

      .highlight-quote::after {
        bottom: 0.5rem;
        right: 1rem;
        font-size: 2rem;
      }
    }
  </style>


  <!-- Article Container -->
  <main class="article-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb sans" aria-label="Breadcrumb">
      <a href="/">Home</a>
      <span class="breadcrumb-sep">→</span>
      <a href="/archive">Archive</a>
      {issueNumber && (
        <>
          <span class="breadcrumb-sep">→</span>
          <a href={`/issues/${issueNumber}`}>Issue {String(issueNumber).padStart(3, '0')}</a>
        </>
      )}
    </nav>

    <!-- Article Header -->
    <header class="article-header">
      <div class="article-meta-top">
        <span class={`article-type ${typeClass} sans`}>{type.charAt(0).toUpperCase() + type.slice(1)}</span>
        <time class="article-date sans">{formatDate(publishDate)}</time>
      </div>
      
      <h1 class="article-title">{title}</h1>
      
      {subtitle && (
        <p class="article-subtitle">{subtitle}</p>
      )}
      
      <div class="article-meta-bottom">
        <div class="article-source sans">
          {originalUrl ? (
            <a href={originalUrl} class="source-link" target="_blank" rel="noopener">{source} ↗</a>
          ) : (
            <span class="source-link">{source}</span>
          )}
        </div>
        <div class="article-stats sans">
          <span>{readingTime} min read</span>
          {issueNumber && (
            <>
              <span>·</span>
              <span>Issue #{String(issueNumber).padStart(3, '0')}</span>
            </>
          )}
        </div>
      </div>
    </header>

    {/* Curator's Notes */}
    {curatorNotes && (
      <aside class="curator-section">
        <div class="curator-label sans">Why I rescued this</div>
        <div class="curator-notes">
          <p>{curatorNotes}</p>
        </div>
      </aside>
    )}

    {/* Highlight Quote */}
    {pullQuote && (
      <blockquote class="highlight-quote">
        {pullQuote}
      </blockquote>
    )}

    {/* Article Content */}
    <div class="article-content article-excerpt">
      <EmbedProcessor>
        <slot />
      </EmbedProcessor>
    </div>

    {/* Original Link */}
    {originalUrl && (
      <a href={originalUrl} class="original-link sans" target="_blank" rel="noopener">
        Read the original
      </a>
    )}

    {/* Tags Section */}
    {tags.length > 0 && (
      <section class="tags-section">
        <div class="tags-label sans">Filed under</div>
        <div class="tags-list">
          {tags.map(tag => (
            <a href={`/topics/${tag}`} class="tag sans">{tag.replace('-', ' ')}</a>
          ))}
        </div>
      </section>
    )}

    {/* Social Share Section */}
    <SocialShare 
      title={title}
      url={Astro.url.href}
      description={subtitle || `${title} from From the Dumpster Fire`}
    />
  </main>
</BaseLayout>