---
import BaseLayout from './BaseLayout.astro';
import SocialShare from '../components/SocialShare.astro';
import EmbedProcessor from '../components/EmbedProcessor.astro';

export interface Props {
  title: string;
  subtitle?: string;
  source: string;
  originalUrl?: string;
  publishDate: string;
  readingTime: number;
  type: string;
  issueNumber?: number;
  curatorNotes?: string;
  pullQuote?: string;
  tags?: string[];
}

const { 
  title, 
  subtitle, 
  source, 
  originalUrl, 
  publishDate, 
  readingTime, 
  type, 
  issueNumber, 
  curatorNotes, 
  pullQuote,
  tags = []
} = Astro.props;

const typeClassMap: { [key: string]: string } = {
  essay: 'meta-essay',
  podcast: 'meta-podcast',
  newsletter: 'meta-newsletter',
  video: 'meta-video',
  book: 'meta-book',
  paper: 'meta-paper',
  thread: 'meta-thread'
};

const typeClass = typeClassMap[type.toLowerCase()] || 'meta-essay';

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric', 
    year: 'numeric' 
  });
};
---

<BaseLayout title={title} issueNumber={issueNumber}>
  <style is:global>
    .article-container {
      max-width: 680px;
      margin: 0 auto;
      padding: var(--spacing-xl) 2rem;
    }
    
    .breadcrumb {
      font-size: .8rem;
      color: var(--text-tertiary);
      margin-bottom: 2rem;
    }
    
    .breadcrumb a {
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color .2s;
    }
    
    .breadcrumb a:hover {
      color: var(--text-secondary);
    }
    
    .breadcrumb-sep {
      margin: 0 .5rem;
      opacity: 0.4;
    }
    
    .article-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border-light);
    }
    
    .article-meta-top {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .article-type {
      font-size: .7rem;
      color: var(--text-tertiary);
      margin-bottom: .5rem;
      letter-spacing: .08em;
      display: inline-block;
      padding: 0;
      background: none;
      border: none;
      font-weight: 600;
      text-transform: uppercase;
    }

    .meta-essay {
      color: #7CA3CC;
    }

    .meta-podcast {
      color: #6BB5A3;
    }

    .meta-newsletter {
      color: #A188B5;
    }

    .meta-video {
      color: #E89A9A;
    }

    .meta-book {
      color: #6FA8A3;
    }

    .meta-paper {
      color: #D09080;
    }

    .meta-thread {
      color: #C9A865;
    }
    
    .article-date {
      font-size: .85rem;
      color: var(--text-tertiary);
    }
    
    .article-title {
      font-size: 2.4rem;
      line-height: 1.3;
      margin-bottom: var(--spacing-md);
      font-weight: 400;
      letter-spacing: -0.02em;
    }
    
    .article-subtitle {
      font-size: 1.2rem;
      line-height: 1.5;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 1.5rem;
    }
    
    .article-meta-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    
    .article-source .source-label {
      color: var(--text-tertiary);
    }
    
    .article-source .source-link {
      color: var(--text-secondary);
      text-decoration: none;
      border-bottom: 1px solid var(--border-light);
      transition: border-color .2s;
      font-weight: 500;
      letter-spacing: .01em;
    }
    
    .article-source .source-link:hover {
      border-color: var(--text-secondary);
    }
    
    .article-stats {
      display: flex;
      gap: 1.5rem;
      font-size: .85rem;
      color: var(--text-tertiary);
    }
    
    .curator-section {
      background: linear-gradient(to right, rgba(200, 230, 201, .08), transparent);
      padding: var(--spacing-md) 0;
      padding-left: var(--spacing-md);
      border-radius: 0;
      margin-bottom: var(--spacing-xl);
      border-left: 2px solid rgba(200, 230, 201, .4);
    }
    
    .curator-label {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-tertiary);
      margin-bottom: .75rem;
    }
    
    .curator-notes {
      font-size: 1rem;
      line-height: 1.7;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .highlight-quote {
      position: relative;
      padding: 2rem 2.5rem;
      padding-top: 3rem;
      margin: var(--spacing-lg) 0;
      background: linear-gradient(135deg, rgba(255, 181, 181, .08) 0%, rgba(181, 216, 255, .06) 100%);
      border-left: 3px solid rgba(231, 76, 60, .4);
      font-size: 1.15rem;
      line-height: 1.8;
      color: var(--text-primary);
      font-style: italic;
      border-radius: 0 4px 4px 0;
    }
    
    .highlight-quote::before {
      content: "\201C";
      position: absolute;
      top: -10px;
      left: 20px;
      font-size: 4rem;
      color: rgba(231, 76, 60, .25);
      font-family: "Times New Roman", Times, serif;
      line-height: 1;
      font-weight: bold;
    }
    
    .article-excerpt {
      font-size: 1.15rem;
      line-height: 1.85;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }
    
    .article-excerpt p {
      margin-bottom: var(--spacing-md);
    }
    
    .article-excerpt p:last-child {
      margin-bottom: 0;
    }
    
    .original-link {
      display: inline-block;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      margin: 2.5rem 0;
      padding: 1rem 1.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 4px;
      border-left: 3px solid var(--pastel-blue);
    }
    
    .tags-section {
      margin: 3rem 0;
      padding-top: 2rem;
      border-top: 1px solid var(--border-light);
    }
    
    .tags-label {
      font-size: .85rem;
      color: var(--text-tertiary);
      margin-bottom: 1rem;
    }
    
    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
    }
    
    .tag {
      font-size: .8rem;
      padding: .3rem .8rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all .2s;
    }
    
    .tag:hover {
      background: var(--pastel-yellow);
      border-color: transparent;
      color: var(--text-primary);
    }
    
    .share-section {
      position: fixed;
      left: 2rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .share-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: var(--text-tertiary);
      transition: all .2s;
      font-size: .9rem;
    }
    
    .share-btn:hover {
      background: var(--pastel-sage);
      border-color: transparent;
      color: var(--text-primary);
    }
    
    @media (max-width: 1200px) {
      .share-section {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      .article-container {
        padding: 2rem 1.5rem;
      }
      
      .article-title {
        font-size: 1.8rem;
      }
      
      .article-meta-bottom {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>

  <!-- Share Buttons (Fixed Left) -->
  <aside class="share-section" aria-label="Share this article">
    <a href="#" class="share-btn" title="Share on Twitter">ùïè</a>
    <a href="#" class="share-btn" title="Copy link">üîó</a>
    <a href="#" class="share-btn" title="Save to reading list">üìë</a>
  </aside>

  <!-- Article Container -->
  <main class="article-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb sans" aria-label="Breadcrumb">
      <a href="/">Home</a>
      <span class="breadcrumb-sep">‚Üí</span>
      <a href="/archive">Archive</a>
      {issueNumber && (
        <>
          <span class="breadcrumb-sep">‚Üí</span>
          <a href={`/issues/${issueNumber}`}>Issue {String(issueNumber).padStart(3, '0')}</a>
        </>
      )}
    </nav>

    <!-- Article Header -->
    <header class="article-header">
      <div class="article-meta-top">
        <span class={`article-type ${typeClass} sans`}>{type.charAt(0).toUpperCase() + type.slice(1)}</span>
        <time class="article-date sans">{formatDate(publishDate)}</time>
      </div>
      
      <h1 class="article-title">{title}</h1>
      
      {subtitle && (
        <p class="article-subtitle">{subtitle}</p>
      )}
      
      <div class="article-meta-bottom">
        <div class="article-source sans">
          {originalUrl ? (
            <a href={originalUrl} class="source-link" target="_blank" rel="noopener">{source} ‚Üó</a>
          ) : (
            <span class="source-link">{source}</span>
          )}
        </div>
        <div class="article-stats sans">
          <span>{readingTime} min read</span>
          {issueNumber && (
            <>
              <span>¬∑</span>
              <span>Issue #{String(issueNumber).padStart(3, '0')}</span>
            </>
          )}
        </div>
      </div>
    </header>

    {/* Curator's Notes */}
    {curatorNotes && (
      <aside class="curator-section">
        <div class="curator-label sans">Why I rescued this</div>
        <div class="curator-notes">
          <p>{curatorNotes}</p>
        </div>
      </aside>
    )}

    {/* Highlight Quote */}
    {pullQuote && (
      <blockquote class="highlight-quote">
        {pullQuote}
      </blockquote>
    )}

    {/* Article Content */}
    <div class="article-content article-excerpt">
      <EmbedProcessor>
        <slot />
      </EmbedProcessor>
    </div>

    {/* Original Link */}
    {originalUrl && (
      <a href={originalUrl} class="original-link sans" target="_blank" rel="noopener">
        Read the original
      </a>
    )}

    {/* Tags Section */}
    {tags.length > 0 && (
      <section class="tags-section">
        <div class="tags-label sans">Filed under</div>
        <div class="tags-list">
          {tags.map(tag => (
            <a href={`/topics/${tag}`} class="tag sans">{tag.replace('-', ' ')}</a>
          ))}
        </div>
      </section>
    )}

    {/* Social Share Section */}
    <SocialShare 
      title={title}
      url={Astro.url.href}
      description={subtitle || `${title} from From the Dumpster Fire`}
    />
  </main>
</BaseLayout>